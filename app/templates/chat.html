{% extends "base.html" %}

{% block content %}
<div class="chat-layout">
  <aside class="sidebar">
    <h3>채널</h3>
    <ul>
      {% for ch in channels %}
        <li class="{% if ch.id == channel.id %}active{% endif %}">
          <a href="/chat?id={{ ch.slug }}">{{ ch.name }}</a>
        </li>
      {% endfor %}
    </ul>
  </aside>

  <main class="chat-main" data-channel="{{ channel.slug }}" data-can-send="{{ 'true' if can_send else 'false' }}">
    <div class="chat-header">
      <div>
        <h2>{{ channel.name }}</h2>
        <p>{{ channel.description }}</p>
      </div>
    </div>
    <div id="chatMessages" class="chat-messages">
      {% if not can_read %}
        <p class="empty">읽기 권한이 없습니다.</p>
      {% else %}
        {% for message in messages %}
          <div class="message" data-message-id="{{ message.id }}" data-user-id="{{ message.user_id }}">
            <a href="/profile?usr={{ message.user.email_prefix }}" class="avatar-link">
              <img src="{{ message.user.avatar_url|media }}" alt="avatar">
            </a>
            <div class="message-body">
              <div class="message-meta">
                <a href="/profile?usr={{ message.user.email_prefix }}">{{ message.user.name }}</a>
                <span>{{ message.created_at|datetime }}</span>
                {% if message.updated_at and message.updated_at != message.created_at %}
                  <span class="edited">수정됨</span>
                {% endif %}
              </div>
              {% if message.reply_to %}
                <div class="reply-preview">↳ {{ message.reply_to.content }}</div>
              {% endif %}
              <div class="message-content">{{ message.content }}</div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    <div id="replyBanner" class="reply-banner hidden"></div>
    <div class="chat-input">
      <textarea id="chatInput" placeholder="메시지를 입력하세요..." {% if not can_send %}disabled{% endif %}></textarea>
      <button class="btn primary" id="sendButton" {% if not can_send %}disabled{% endif %}>전송</button>
      {% if not can_send %}
        <p class="hint">이 채널은 메시지 전송 권한이 없습니다.</p>
      {% endif %}
    </div>
  </main>

  <aside class="online">
    <h3>온라인</h3>
    <ul id="onlineList"></ul>
  </aside>
</div>

<div id="contextMenu" class="context-menu hidden">
  <button data-action="reply">답장</button>
  <button data-action="edit">수정</button>
  <button data-action="delete">삭제</button>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  window.KJB_CURRENT_USER_ID = {{ current_user.id }};
  window.KJB_IS_ADMIN = {{ 'true' if current_user.is_admin else 'false' }};
</script>
<script src="/static/js/chat.js"></script>
{% endblock %}
